<x-filament-panels::page>
    <style>
        /* Force inherit global Filament fonts */
        .report-dashboard, .fi-section, .fi-card { font-family: inherit !important; }
        
        .chart-main-row { display: flex; align-items: flex-start; gap: 40px; width: 100%; padding: 20px 0; }
        .chart-visual-container { position: relative; width: 380px; height: 380px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .chart-visual-container canvas { position: relative; z-index: 1; }
        
        .chart-center-overlay {
            position: absolute; display: flex; flex-direction: column;
            align-items: center; justify-content: center; pointer-events: none;
            background: #fff; border-radius: 50%; width: 68%; height: 68%;
            z-index: 10; box-shadow: inset 0 4px 15px rgba(0,0,0,0.03), 0 2px 4px rgba(0,0,0,0.02);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .pct-main { font-size: 4.2rem; font-weight: 900; color: #0f172a; line-height: 0.9; transition: all 0.3s ease; }
        .lbl-sub { font-size: 0.8rem; font-weight: 800; color: #94a3b8; margin-top: 8px; text-align: center; max-width: 140px; text-transform: uppercase; letter-spacing: 1.5px; }

        .legend-list { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .legend-item { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 10px 16px; border-radius: 10px; cursor: pointer; transition: all 0.2s;
            border-bottom: 1px solid transparent;
        }
        .legend-item:hover { background: #f8fafc; }
        .legend-item.active-item { background: #eff6ff; box-shadow: 0 2px 8px -2px rgba(59, 130, 246, 0.1); }
        
        .legend-info { display: flex; align-items: center; gap: 14px; }
        .legend-color { width: 12px; height: 12px; border-radius: 4px; flex-shrink: 0; }
        .legend-label { font-size: 0.9rem; font-weight: 700; color: #475569; }
        .legend-value { font-size: 1rem; font-weight: 800; color: #1e293b; }

        /* JIRA Premium Tooltip */
        #jira-custom-tooltip {
            position: absolute; background: white; border-radius: 8px; 
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0; padding: 14px; z-index: 9999; 
            pointer-events: none; opacity: 0; transition: opacity 0.2s; 
            min-width: 180px;
        }
        #jira-custom-tooltip h4 { font-size: 1rem; font-weight: 800; margin: 0 0 4px 0; color: #0f172a; }
        #jira-custom-tooltip p { font-size: 0.7rem; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

        .premium-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.8rem; }
        .premium-table th { padding: 12px 16px; font-weight: 700; color: #64748b; border-bottom: 1px solid #e2e8f0; text-align: left; background: #f8fafc; text-transform: uppercase; }
        .premium-table td { padding: 12px 16px; border-bottom: 1px solid #f8fafc; color: #1e293b; }
        .progress-bar-bg { background: #f1f5f9; border-radius: 999px; height: 7px; width: 100%; overflow: hidden; position: relative; }
        .progress-bar-fill { background: #3b82f6; height: 100%; border-radius: 999px; transition: width 0.8s ease; }
    </style>

    <div class="report-dashboard space-y-6">
        
        {{-- FILTER SECTION --}}
        <x-filament::section>
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <h2 style="font-size: 0.875rem; font-weight: 800; color: #111827; text-transform: uppercase;">Report Filter</h2>
                <form method="GET" style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; background: #fff; border: 2px solid #e5e7eb; border-radius: 0.5rem; padding: 0.4rem 0.75rem;">
                        <input type="hidden" name="startYear" value="{{ $startYear }}">
                        <select name="startMonth" style="background: transparent; border: none; font-size: 0.8rem; font-weight: 700; color: #111827; outline: none;">
                            @foreach(range(1, 12) as $m)
                                <option value="{{ $m }}" @selected($m == $startMonth)>{{ \Carbon\Carbon::create(2000, $m, 1)->format('M') }}</option>
                            @endforeach
                        </select>
                        <select onchange="this.previousElementSibling.value = this.value" style="background: transparent; border: none; font-size: 0.8rem; font-weight: 700; color: #111827; outline: none;">
                            @for($y = 2024; $y <= now()->year + 2; $y++)
                                <option value="{{ $y }}" @selected($y == $startYear)>{{ $y }}</option>
                            @endfor
                        </select>
                        <span style="color: #cbd5e1; margin: 0 0.75rem; font-weight: 900;">â€”</span>
                        <select name="endMonth" style="background: transparent; border: none; font-size: 0.8rem; font-weight: 700; color: #111827; outline: none;">
                            @foreach(range(1, 12) as $m)
                                <option value="{{ $m }}" @selected($m == $endMonth)>{{ \Carbon\Carbon::create(2000, $m, 1)->format('M') }}</option>
                            @endforeach
                        </select>
                        <select name="endYear" style="background: transparent; border: none; font-size: 0.8rem; font-weight: 700; color: #111827; outline: none;">
                            @for($y = 2024; $y <= now()->year + 2; $y++)
                                <option value="{{ $y }}" @selected($y == $endYear)>{{ $y }}</option>
                            @endfor
                        </select>
                    </div>
                    <x-filament::button type="submit" color="primary" icon="heroicon-o-funnel" size="sm" style="font-weight: 800; text-transform: uppercase;">
                        Apply
                    </x-filament::button>
                </form>
            </div>
        </x-filament::section>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            {{-- WORKLOAD CHART (Jira-Style Enhanced) --}}
            <x-filament::section>
                <x-slot name="heading">
                    <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                        <span style="font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;">Project Status Distribution</span>
                        <div style="display: flex; gap: 8px;">
                            <x-heroicon-o-arrows-pointing-out style="width: 14px; height: 14px; color: #94a3b8;" />
                        </div>
                    </div>
                </x-slot>

                <div id="workload-component" x-data="{ 
                    activeIndex: -1, 
                    hoverIndex: -1,
                    labels: @json($reportData['workload']['labels']),
                    data: @json($reportData['workload']['data']),
                    total: {{ $reportData['workload']['total'] }},
                    get currentLabel() { 
                        let idx = this.hoverIndex !== -1 ? this.hoverIndex : this.activeIndex;
                        return idx !== -1 ? this.labels[idx] : 'Total Projects';
                    },
                    get currentPct() {
                        let idx = this.hoverIndex !== -1 ? this.hoverIndex : this.activeIndex;
                        if (this.total === 0) return '0%';
                        if (idx === -1) return '100%';
                        return Math.round((this.data[idx] / this.total) * 100) + '%';
                    },
                    get currentCount() {
                        let idx = this.hoverIndex !== -1 ? this.hoverIndex : this.activeIndex;
                        if (idx === -1) return this.total;
                        return this.data[idx];
                    },
                    setHover(idx) {
                        this.hoverIndex = idx;
                        if (window.workloadChart) {
                            if (idx !== -1) {
                                window.workloadChart.setActiveElements([{ datasetIndex: 0, index: idx }]);
                            } else {
                                window.workloadChart.setActiveElements([]);
                            }
                            window.workloadChart.update();
                        }
                    }
                }" class="w-full">
                    
                    <div class="mb-4">
                        <h3 style="font-size: 1.5rem; font-weight: 800; color: #0f172a;">Project Status</h3>
                        <p style="font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">Total Projects: {{ $reportData['workload']['total'] }}</p>
                    </div>

                    <div class="chart-main-row flex-col xl:flex-row items-center xl:items-start">
                        <div class="chart-visual-container">
                            <canvas id="workloadJiraDonut"></canvas>
                            <div class="chart-center-overlay" :style="hoverIndex !== -1 ? 'transform: scale(1.05); border: 2px solid #eff6ff;' : ''">
                                <div class="pct-main" x-text="currentPct" :style="hoverIndex !== -1 ? 'color: #2563eb; font-size: 4.8rem;' : ''"></div>
                                <div class="lbl-sub" x-text="currentLabel"></div>
                                <div style="font-size: 0.7rem; font-weight: 700; color: #94a3b8; margin-top: 4px;" x-text="'Total: ' + currentCount + ' (' + currentPct + ')'"></div>
                            </div>
                        </div>

                        <div class="legend-list w-full">
                            @php $colors = ['#3b82f6', '#ef4444', '#f59e0b', '#10b981', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f43f5e', '#a855f7']; @endphp
                            @foreach($reportData['workload']['labels'] as $idx => $label)
                                @php $pct = $reportData['workload']['total'] > 0 ? round(($reportData['workload']['data'][$idx] / $reportData['workload']['total']) * 100) : 0; @endphp
                                <div class="legend-item" 
                                     :class="{ 'active-item': activeIndex === {{ $idx }} || hoverIndex === {{ $idx }} }"
                                     @mouseenter="setHover({{ $idx }})" 
                                     @mouseleave="setHover(-1)"
                                     @click="activeIndex = (activeIndex === {{ $idx }} ? -1 : {{ $idx }})">
                                    <div class="legend-info">
                                        <div class="legend-color" style="background: {{ $colors[$idx % count($colors)] }}"></div>
                                        <span class="legend-label">{{ $label }}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 0.75rem; font-weight: 700; color: #94a3b8;">{{ $pct }}%</span>
                                        <span class="legend-value">{{ $reportData['workload']['data'][$idx] }}</span>
                                    </div>
                                </div>
                            @endforeach
                        </div>
                    </div>
                </div>
            </x-filament::section>

            <div style="display: flex; flex-direction: column; gap: 24px;">
                {{-- TABLES... --}}
                <x-filament::section>
                    <x-slot name="heading">
                        <span style="font-size: 11px; font-weight: 800; text-transform: uppercase;">Application Problems</span>
                    </x-slot>
                    <table class="premium-table">
                        <thead>
                            <tr><th>App Name</th><th>Issues</th><th>T:</th></tr>
                        </thead>
                        <tbody>
                            @foreach($reportData['problems'] as $app => $count)
                                <tr>
                                    <td style="font-weight: 600;">{{ $app }}</td>
                                    <td style="color: #3b82f6; font-weight: 800;">{{ $count }}</td>
                                    <td style="background: #eff6ff; color: #2563eb; font-weight: 900;">{{ $count }}</td>
                                </tr>
                            @endforeach
                        </tbody>
                        @if(count($reportData['problems']) > 0)
                        <tfoot>
                            <tr style="background: #f8fafc; font-weight: 800;">
                                <td style="border-top: 2px solid #e2e8f0;">Total Issues:</td>
                                <td style="border-top: 2px solid #e2e8f0; color: #3b82f6;">{{ array_sum($reportData['problems']) }}</td>
                                <td style="border-top: 2px solid #e2e8f0; color: #2563eb; background: #eff6ff;">{{ array_sum($reportData['problems']) }}</td>
                            </tr>
                        </tfoot>
                        @endif
                    </table>
                </x-filament::section>

                {{-- ACTIVITY PERCENTAGE --}}
                <x-filament::section>
                    <x-slot name="heading">
                        <span style="font-size: 11px; font-weight: 800; text-transform: uppercase;">Activity Percentage</span>
                    </x-slot>
                    <table class="premium-table">
                        <thead>
                            <tr><th>Activity</th><th style="text-align: center;">Count</th><th>Share</th></tr>
                        </thead>
                        <tbody>
                            @foreach($reportData['activities'] as $type => $count)
                                @php $pct = $reportData['totalActivity'] > 0 ? round(($count / $reportData['totalActivity']) * 100) : 0; @endphp
                                <tr>
                                    <td style="color: #3b82f6; font-weight: 800; text-transform: uppercase;">{{ $type }}</td>
                                    <td style="font-weight: 700; text-align: center;">{{ $count }}</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: {{ $pct }}%"></div></div>
                                            <span style="font-size: 10px; font-weight: 900; color: #64748b; min-width: 30px; text-align: right;">{{ $pct }}%</span>
                                        </div>
                                    </td>
                                </tr>
                            @endforeach
                        </tbody>
                    </table>
                </x-filament::section>
            </div>
        </div>
    </div>

    {{-- TOOLTIP ELEMENT --}}
    <div id="jira-custom-tooltip">
        <h4 id="tt-name">Application</h4>
        <p id="tt-detail">0 Projects (0%)</p>
    </div>

    @once
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const ctx = document.getElementById('workloadJiraDonut');
            const ttEl = document.getElementById('jira-custom-tooltip');
            const ttName = document.getElementById('tt-name');
            const ttDetail = document.getElementById('tt-detail');

            if (!ctx) return;

            const labels = @json($reportData['workload']['labels']);
            const dataValues = @json($reportData['workload']['data']);
            const colors = ['#3b82f6', '#ef4444', '#f59e0b', '#10b981', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f43f5e', '#a855f7'];

            window.workloadChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: colors,
                        hoverBackgroundColor: colors.map(c => c + 'ee'),
                        borderWidth: 0,
                        hoverOffset: 20,
                        spacing: 2
                    }]
                },
                options: {
                    cutout: '72%',
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 800,
                        easing: 'easeOutQuart'
                    },
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { 
                            enabled: false,
                            external: function(context) {
                                const { chart, tooltip } = context;
                                
                                if (tooltip.opacity === 0) {
                                    ttEl.style.opacity = '0';
                                    return;
                                }

                                const idx = tooltip.dataPoints[0].dataIndex;
                                const label = labels[idx];
                                const value = dataValues[idx];
                                const total = dataValues.reduce((a, b) => a + b, 0);
                                const pct = total > 0 ? Math.round((value / total) * 100) : 0;

                                ttName.innerText = label;
                                ttDetail.innerText = `${value} Projects (${pct}%)`;

                                const pos = chart.canvas.getBoundingClientRect();
                                ttEl.style.opacity = '1';
                                ttEl.style.left = (pos.left + window.pageXOffset + tooltip.caretX + 20) + 'px';
                                ttEl.style.top = (pos.top + window.pageYOffset + tooltip.caretY - 100) + 'px';
                            }
                        } 
                    },
                    onHover: (event, elements) => {
                        const alpineEl = document.getElementById('workload-component');
                        if (alpineEl && window.Alpine) {
                            const data = window.Alpine.$data(alpineEl);
                            if (elements.length > 0) {
                                data.hoverIndex = elements[0].index;
                                event.native.target.style.cursor = 'pointer';
                            } else {
                                data.hoverIndex = -1;
                                event.native.target.style.cursor = 'default';
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        const alpineEl = document.getElementById('workload-component');
                        if (alpineEl && window.Alpine && elements.length > 0) {
                            const data = window.Alpine.$data(alpineEl);
                            const idx = elements[0].index;
                            data.activeIndex = (data.activeIndex === idx ? -1 : idx);
                        }
                    }
                }
            });
        });
    </script>
    @endonce
</x-filament-panels::page>
